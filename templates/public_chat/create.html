{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Create a New Public Chat</h2>
    
    <form id="createChatForm" class="mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label for="chatName" class="form-label">Chat Name *</label>
                    <input type="text" class="form-control" id="chatName" placeholder="e.g., Coffee & Books Meetup" required>
                </div>
                
                <div class="mb-3">
                    <label for="chatDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="chatDescription" rows="3" placeholder="Describe the activity..."></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="scheduledDate" class="form-label">Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="scheduledDate" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="scheduledEndTime" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="scheduledEndTime">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="locationName" class="form-label">Location Name</label>
                    <input type="text" class="form-control" id="locationName" placeholder="e.g., Cafe Noir Q1">
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="latitude" class="form-label">Latitude</label>
                        <input type="number" step="0.0001" class="form-control" id="latitude" placeholder="10.7769">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="longitude" class="form-label">Longitude</label>
                        <input type="number" step="0.0001" class="form-control" id="longitude" placeholder="106.6955">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="maxMembers" class="form-label">Max Members</label>
                        <input type="number" class="form-control" id="maxMembers" min="2" max="10" value="5">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="isAnonymous" checked>
                            <label class="form-check-label" for="isAnonymous">
                                Anonymous Chat (members can't see each other's names)
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg">Create Chat</button>
                <a href="{{ url_for('public_chat.browse_public_chats') }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </div>
    </form>
</div>

<script>
    document.getElementById('createChatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            name: document.getElementById('chatName').value,
            description: document.getElementById('chatDescription').value,
            scheduled_date: new Date(document.getElementById('scheduledDate').value).toISOString(),
            scheduled_end_time: document.getElementById('scheduledEndTime').value ? 
                new Date(document.getElementById('scheduledEndTime').value).toISOString() : 
                null,
            location_name: document.getElementById('locationName').value,
            latitude: document.getElementById('latitude').value ? parseFloat(document.getElementById('latitude').value) : null,
            longitude: document.getElementById('longitude').value ? parseFloat(document.getElementById('longitude').value) : null,
            max_members: parseInt(document.getElementById('maxMembers').value),
            is_anonymous: document.getElementById('isAnonymous').checked
        };
        
        try {
            const res = await fetch('/public-chat/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert('✅ Chat created successfully!');
                window.location.href = `/public-chat/${result.chat_id}`;
            } else {
                alert('❌ Error: ' + result.error);
            }
        } catch (err) {
            alert('❌ Error creating chat: ' + err);
        }
    });
    
    // Auto-set end time to 2 hours after start
    document.getElementById('scheduledDate').addEventListener('change', () => {
        const startDate = new Date(document.getElementById('scheduledDate').value);
        startDate.setHours(startDate.getHours() + 2);
        document.getElementById('scheduledEndTime').value = startDate.toISOString().slice(0, 16);
    });
</script>
{% endblock %}
