{% extends "layout.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* --- NÂNG CẤP CHỦ ĐỀ DU LỊCH --- */
    #chat-container {
        display: flex;
        flex-direction: row;
        height: 75vh;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    #user-sidebar {
        flex: 0 0 250px;
        background-color: #f7f3f0; /* Màu kem/cát nhạt */
        border-right: 1px solid #dee2e6;
        padding: 1rem;
        overflow-y: auto;
    }
    #user-sidebar h5 {
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.5rem;
    }
    #user-sidebar .list-group-item {
        border: none;
        padding: 0.5rem 0.25rem;
        font-weight: 500;
        background-color: transparent; /* Nền trong suốt */
    }
    #user-sidebar .list-group-item .online-dot {
        height: 8px;
        width: 8px;
        background-color: #28a745;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    #chat-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        
        /* Chúng ta dùng 'url_for' của Jinja2 để lấy đúng đường dẫn ảnh */
        background-image: url("{{ url_for('static', filename='img/background-chat.jpg') }}");

        background-size: cover;
        background-position: center;
    }
    #messages {
        flex-grow: 1;
        overflow-y: scroll;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        
        /* === ĐÂY LÀ PHẦN SỬA LỖI OPACITY === */
        /* Giảm từ 0.9 xuống 0.75 để trong suốt hơn */
        background-color: rgba(255, 255, 255, 0.75);
        /* ================================= */
    }
    .message-bubble {
        max-width: 75%;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 1rem;
        word-wrap: break-word;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08); /* Bóng mờ đẹp hơn */
    }
    .message-bubble img {
        max-width: 100%;
        border-radius: 0.5rem;
        margin-top: 5px;
    }
    .message-self {
        align-self: flex-end;
        background-color: #007bff; /* Màu xanh dương (Bầu trời/Biển) */
        color: white;
        border-bottom-right-radius: 0;
    }
    .message-other {
        align-self: flex-start;
        background-color: #ffffff; /* Màu trắng */
        color: #212529;
        border: 1px solid #f0f0f0;
        border-bottom-left-radius: 0;
    }
    .message-info {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .message-info-self { text-align: right; color: rgba(255,255,255,0.85); }
    .message-info-other { text-align: left; }
    .message-status {
        align-self: center;
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0.5rem 0;
    }
    #chat-form-container {
        border-top: 1px solid #dee2e6;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    #emoji-picker {
        position: absolute;
        bottom: 80px; 
        right: 10px;
        z-index: 1000;
        display: none; 
    }
    #emoji-btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
</style>

<div class="container-fluid">
    <h2 class="mb-3">
        <i class="bi bi-compass text-primary"></i>
        Chat Room: <span class="text-primary">{{ room.name }}</span>
    </h2>
    <p class="text-muted">{{ room.description }}</p>

    <div id="chat-container" class="shadow-sm">
        
        <div id="user-sidebar">
            <h5><i class="bi bi-person-check-fill me-2"></i>Online Users (<span id="user-count">0</span>)</h5>
            <ul id="user-list" class="list-group">
                </ul>
        </div>

        <div id="chat-main">
            <div id="messages">
                <div class="message-status">Welcome to the chat! Loading history...</div>
            </div>

            <div id="typing-status" class="small text-muted px-3 py-2" style="height: 30px; background-color: rgba(255, 255, 255, 0.75);">
                </div>
            
            <div id="emoji-picker">
                <emoji-picker></emoji-picker>
            </div>

            <div id="chat-form-container">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Type your message or paste a GIF URL..." autocomplete="off" aria-label="Message" required>
                        
                        <button class="btn btn-outline-secondary" type="button" id="emoji-btn">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send-fill"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io();
            const roomName = '{{ room.name }}';
            const currentUsername = '{{ current_user.username }}';

            const messageContainer = document.getElementById('messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const userList = document.getElementById('user-list');
            const userCount = document.getElementById('user-count');
            const emojiPicker = document.getElementById('emoji-picker');
            const emojiBtn = document.getElementById('emoji-btn');
            const typingStatus = document.getElementById('typing-status');
            let typingTimer;

            function scrollToBottom() { messageContainer.scrollTop = messageContainer.scrollHeight; }
            function addMessage(html) { messageContainer.appendChild(html); }

            // === HÀM NÂNG CẤP ĐỂ HIỂN THỊ GIF/ẢNH ===
            function createMessageHtml(data) {
                let isSelf = data.username === currentUsername;
                let bubbleClass = isSelf ? 'message-self' : 'message-other';
                let infoClass = isSelf ? 'message-info-self' : 'message-info-other';
                let usernameDisplay = isSelf ? 'You' : data.username;

                // Hàm kiểm tra URL ảnh/gif
                function isImageUrl(url) {
                    return(url.match(/\.(jpeg|jpg|gif|png)$/) != null);
                }

                let messageBodyHtml;
                if (isImageUrl(data.msg)) {
                    // Nếu là URL ảnh, hiển thị thẻ <img>
                    messageBodyHtml = `<img src="${data.msg}" alt="User image">`;
                } else {
                    // Nếu là văn bản, chỉ hiển thị văn bản (an toàn)
                    const bodyDiv = document.createElement('div');
                    bodyDiv.textContent = data.msg;
                    messageBodyHtml = bodyDiv.innerHTML; // Lấy HTML an toàn
                }

                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message-bubble', bubbleClass);

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('message-info', infoClass);
                infoDiv.innerHTML = `<strong>${usernameDisplay}</strong> <small class="ms-2">${data.timestamp}</small>`;
                
                // Thêm nội dung tin nhắn (văn bản hoặc ảnh)
                const bodyContainer = document.createElement('div');
                bodyContainer.classList.add('message-body');
                bodyContainer.innerHTML = messageBodyHtml;

                msgDiv.appendChild(infoDiv);
                msgDiv.appendChild(bodyContainer);
                return msgDiv;
            }
            // ===========================================

            function createStatusHtml(data) {
                const statusDiv = document.createElement('div');
                statusDiv.classList.add('message-status');
                statusDiv.innerHTML = `<em>${data.msg}</em>`;
                return statusDiv;
            }

            // --- Logic cho Emoji Picker (không đổi) ---
            emojiBtn.addEventListener('click', () => {
                emojiPicker.style.display = (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') ? 'block' : 'none';
            });
            emojiPicker.addEventListener('emoji-click', event => {
                messageInput.value += event.detail.unicode;
            });


            // --- Logic cho "Đang gõ phím" (không đổi) ---
            messageInput.addEventListener('input', () => {
                clearTimeout(typingTimer);
                socket.emit('typing', { room: roomName });
                typingTimer = setTimeout(() => {
                    socket.emit('stopped_typing', { room: roomName });
                }, 2000);
            });
            socket.on('typing_status', (data) => {
                if (data.isTyping) {
                    typingStatus.textContent = `${data.username} is typing...`;
                } else {
                    if (typingStatus.textContent.includes(data.username)) {
                         typingStatus.textContent = '';
                    }
                }
            });

            // --- Trình xử lý sự kiện Socket.IO (không đổi) ---
            socket.on('connect', function() {
                socket.emit('join', { 'room': roomName });
            });
            
            socket.on('load_history', function(messages) {
                messageContainer.innerHTML = ''; 
                messages.forEach(function(data) { addMessage(createMessageHtml(data)); });
                scrollToBottom(); 
            });

            socket.on('receive_message', function(data) {
                addMessage(createMessageHtml(data));
                scrollToBottom(); 
                if (typingStatus.textContent.includes(data.username)) {
                    typingStatus.textContent = '';
                }
            });

            socket.on('status', function(data) {
                addMessage(createStatusHtml(data));
                scrollToBottom(); 
            });

            socket.on('user_list', function(data) {
                userList.innerHTML = '';
                userCount.textContent = data.users.length;
                data.users.forEach(function(username) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.innerHTML = `<span class="online-dot"></span> ${username}`;
                    userList.appendChild(li);
                });
            });

            chatForm.addEventListener('submit', function(e) {
                e.preventDefault(); 
                let msg = messageInput.value.trim();
                if (msg) {
                    socket.emit('send_message', { 'msg': msg, 'room': roomName });
                    clearTimeout(typingTimer);
                    socket.emit('stopped_typing', { room: roomName });
                    messageInput.value = '';
                    emojiPicker.style.display = 'none';
                }
            });

            window.addEventListener('beforeunload', function() {
                socket.emit('leave', { 'room': roomName });
            });
        });
    </script>
{% endblock %}