{% extends "layout.html" %}

{% block content %}
<style>
    /* Modern chat styles */
    #chat-container {
        display: flex;
        flex-direction: row;
        height: 75vh;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }

    /* Sidebar for user list */
    #user-sidebar {
        flex: 0 0 250px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 1rem;
        overflow-y: auto;
    }

    #user-sidebar h5 {
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.5rem;
    }

    #user-sidebar .list-group-item {
        border: none;
        padding: 0.5rem 0.25rem;
        font-weight: 500;
    }
    #user-sidebar .list-group-item .online-dot {
        height: 8px;
        width: 8px;
        background-color: #28a745; /* green */
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    /* Main chat area */
    #chat-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* Message display area */
    #messages {
        flex-grow: 1;
        overflow-y: scroll;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
    }

    /* Message bubbles */
    .message-bubble {
        max-width: 75%;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }

    .message-self {
        align-self: flex-end;
        background-color: #0d6efd; /* bootstrap primary */
        color: white;
        border-bottom-right-radius: 0;
    }

    .message-other {
        align-self: flex-start;
        background-color: #e9ecef; /* bootstrap light grey */
        color: #212529;
        border-bottom-left-radius: 0;
    }
    
    .message-info {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .message-info-self { text-align: right; }
    .message-info-other { text-align: left; }

    /* Status message (join/leave) */
    .message-status {
        align-self: center;
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0.5rem 0;
    }

    /* Message input form */
    #chat-form-container {
        border-top: 1px solid #dee2e6;
        padding: 1rem;
        background-color: #f8f9fa;
    }
</style>

<div class="container-fluid">
    <h2 class="mb-3">Chat Room: <span class="text-primary">{{ room.name }}</span></h2>
    <p class="text-muted">{{ room.description }}</p>

    <div id="chat-container" class="shadow-sm">
        
        <div id="user-sidebar">
            <h5>Online Users (<span id="user-count">0</span>)</h5>
            <ul id="user-list" class="list-group">
                </ul>
        </div>

        <div id="chat-main">
            <div id="messages">
                <div class="message-status">Welcome to the chat! Loading history...</div>
            </div>

            <div id="chat-form-container">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Type your message..." autocomplete="off" aria-label="Message" required>
                        <button class="btn btn-primary" type="submit">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            // 1. Connect to Socket.IO and get references
            var socket = io();
            const roomName = '{{ room.name }}';
            const currentUsername = '{{ current_user.username }}';

            const messageContainer = document.getElementById('messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const userList = document.getElementById('user-list');
            const userCount = document.getElementById('user-count');

            // --- Helper Functions ---
            function scrollToBottom() {
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            function addMessage(html) {
                messageContainer.appendChild(html);
            }

            // Helper to create message bubble HTML
            function createMessageHtml(data) {
                let isSelf = data.username === currentUsername;
                let bubbleClass = isSelf ? 'message-self' : 'message-other';
                let infoClass = isSelf ? 'message-info-self' : 'message-info-other';
                let usernameDisplay = isSelf ? 'You' : data.username;

                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message-bubble', bubbleClass);

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('message-info', infoClass);
                infoDiv.innerHTML = `<strong>${usernameDisplay}</strong> <small class="text-muted ms-2">${data.timestamp}</small>`;
                
                const bodyDiv = document.createElement('div');
                bodyDiv.classList.add('message-body');
                bodyDiv.textContent = data.msg; // Use textContent to prevent XSS

                msgDiv.appendChild(infoDiv);
                msgDiv.appendChild(bodyDiv);
                return msgDiv;
            }

            // Helper to create status message HTML
            function createStatusHtml(data) {
                const statusDiv = document.createElement('div');
                statusDiv.classList.add('message-status');
                statusDiv.innerHTML = `<em>${data.msg}</em>`;
                return statusDiv;
            }

            // --- Socket.IO Event Handlers ---

            // 2. Emit 'join' event when connected
            socket.on('connect', function() {
                console.log('Connected, emitting join for room:', roomName);
                socket.emit('join', { 'room': roomName });
            });
            
            // 3. Listen for 'load_history'
            socket.on('load_history', function(messages) {
                messageContainer.innerHTML = ''; // Clear "Loading..."
                messages.forEach(function(data) {
                    addMessage(createMessageHtml(data));
                });
                scrollToBottom(); 
            });

            // 4. Listen for 'receive_message'
            socket.on('receive_message', function(data) {
                addMessage(createMessageHtml(data));
                scrollToBottom(); 
            });

            // 5. Listen for 'status' events (joins/leaves)
            socket.on('status', function(data) {
                addMessage(createStatusHtml(data));
                scrollToBottom(); 
            });

            // 6. Listen for 'user_list' updates
            socket.on('user_list', function(data) {
                userList.innerHTML = ''; // Clear list
                let count = data.users.length;
                userCount.textContent = count;
                
                data.users.forEach(function(username) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.innerHTML = `<span class="online-dot"></span> ${username}`;
                    userList.appendChild(li);
                });
            });

            // 7. Handle form submission to send a message
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault(); 
                let msg = messageInput.value.trim();
                if (msg) {
                    socket.emit('send_message', { 'msg': msg, 'room': roomName });
                    messageInput.value = ''; // Clear input
                }
            });

            // 8. Emit 'leave' on disconnect (e.g., closing tab)
            window.addEventListener('beforeunload', function() {
                socket.emit('leave', { 'room': roomName });
            });

        });
    </script>
{% endblock %}