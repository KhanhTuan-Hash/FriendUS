{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<style>
    /* Layout chính */
    .map-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 80px); 
        display: flex; 
        overflow: hidden; 
    }

    #map { 
        flex-grow: 1; 
        height: 100%; 
        width: 100%;
        z-index: 1;
        cursor: crosshair; 
    }
    
    .leaflet-container { height: 100%; width: 100%; }

    /* Nút Find My Location */
    .map-controls {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 1000; 
        background: #fff;
        padding: 1rem;
        border-radius: 0.375rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 220px; 
    }

    /* --- FIX: MỞ RỘNG HỘP CHỈ ĐƯỜNG (TALLER BOX) --- */
    
    .leaflet-routing-container {
        display: none; /* Ẩn mặc định */
        
        position: absolute !important;
        top: 10px !important;     /* Cách đỉnh 10px */
        right: 10px !important;   /* Cách phải 10px */
        
        /* CHIỀU CAO: Đặt cố định thật cao */
        height: 85% !important;       /* Chiếm 85% chiều cao bản đồ */
        min-height: 500px !important; /* Tối thiểu 500px (đảm bảo to gấp đôi cái cũ) */
        width: 400px !important;
        
        background-color: white !important;
        z-index: 5000 !important; 
        box-shadow: -5px 0 15px rgba(0,0,0,0.2) !important;
        border-radius: 8px !important; /* Bo góc một chút cho đẹp */
        margin: 0 !important;
        padding: 0 !important;
        overflow-y: auto !important; /* Cho phép cuộn */
    }

    /* Nội dung bên trong */
    .leaflet-routing-alt {
        width: 100% !important;
        min-height: 100% !important; /* Bung full chiều cao của hộp cha */
        padding: 20px !important;
        box-sizing: border-box !important;
        
        font-size: 16px !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    /* Tiêu đề */
    .leaflet-routing-alt h2 {
        font-size: 24px !important;
        font-weight: 700 !important;
        color: #0d6efd; 
        margin-top: 0 !important;
        margin-bottom: 15px !important;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .leaflet-routing-alt h3 {
        font-size: 18px !important;
        font-weight: 600 !important;
        color: #333;
        margin-bottom: 15px !important;
    }

    /* Các dòng chỉ đường */
    .leaflet-routing-alt tr {
        border-bottom: 1px solid #eee;
        height: 45px; /* Tăng chiều cao mỗi dòng lên một chút */
    }
    
    .leaflet-routing-alt td {
        padding: 12px 8px !important;
        vertical-align: middle;
    }

    .leaflet-routing-alt tr:hover {
        background-color: #f8f9fa !important;
        cursor: pointer;
    }

    .leaflet-routing-collapse-btn { display: none !important; }

    /* Mobile */
    @media (max-width: 768px) {
        .map-controls {
            width: calc(100% - 30px); 
            min-width: unset; 
            left: 50%; 
            transform: translateX(-50%);
        }
        .leaflet-routing-container {
            width: 100% !important;
            height: 60% !important; 
            top: auto !important;
            bottom: 0 !important;
            right: 0 !important;
            border-radius: 20px 20px 0 0 !important; /* Bo tròn góc trên */
            border-top: 4px solid #0d6efd;
        }
    }
</style>

<div class="map-container">
    <div class="map-controls">
        <div class="d-grid mb-2">
            <button class="btn btn-secondary" id="find-me-btn">
                <i class="bi bi-geo-alt-fill"></i> Find My Location
            </button>
        </div>
        <div id="geo-error" class="text-danger small"></div>
    </div>

    <div id="map" 
         data-default-lat="{{ default_lat if default_lat is defined and default_lat is not none else '' }}"
         data-default-lon="{{ default_lon if default_lon is defined and default_lon is not none else '' }}"
         data-locations='{{ locations_data|tojson|safe if locations_data is defined else "[]" }}'
    ></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    function initMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) return;
        
        let defaultLat = parseFloat(mapElement.dataset.defaultLat);
        let defaultLon = parseFloat(mapElement.dataset.defaultLon);
        let defaultZoom = (isNaN(defaultLat) || isNaN(defaultLon)) ? 2 : 13;
        if (isNaN(defaultLat)) { defaultLat = 20; defaultLon = 0; }

        var map = L.map('map', { zoomControl: false }).setView([defaultLat, defaultLon], defaultZoom);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // --- CẤU HÌNH ROUTING ---
        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            show: true, 
            collapsible: false, 
            createMarker: function() { return null; },
            containerClassName: 'leaflet-routing-container' 
        }).addTo(map);

        function toggleRoutingPanel(show) {
            var container = document.querySelector('.leaflet-routing-container');
            if (container) {
                container.style.display = show ? 'block' : 'none';
                if(show) container.scrollTop = 0;
            }
        }

        // Search Bar
        try {
            var geocoder = L.Control.Geocoder.nominatim();
            L.Control.geocoder({ defaultMarkGeocode: false, geocoder: geocoder })
                .on('markgeocode', function(e) { map.fitBounds(e.geocode.bbox); })
                .addTo(map);
        } catch (e) { console.error(e); }

        // --- XỬ LÝ CLICK ---
        var clickMarker;

        function createPopupContent(lat, lon, name, address) {
            var container = document.createElement('div');
            container.style.textAlign = "center";
            container.style.width = "200px";
            
            var titleEl = document.createElement('strong');
            titleEl.innerText = name;
            titleEl.style.display = "block";
            titleEl.style.marginBottom = "5px";

            var addrEl = document.createElement('p');
            addrEl.innerText = address;
            addrEl.style.fontSize = "12px";
            addrEl.className = "text-muted";
            addrEl.style.marginBottom = "10px";

            var viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-primary btn-sm w-100 mb-2';
            viewBtn.innerHTML = '<i class="bi bi-eye"></i> View Details';
            viewBtn.onclick = function() {
                viewBtn.disabled = true;
                viewBtn.innerText = "Saving...";
                fetch('/api/create_location_on_click', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: lat, lon: lon, name: name, address: address})
                })
                .then(r => r.json())
                .then(data => { if(data.url) window.location.href = data.url; })
                .catch(err => { console.error(err); viewBtn.innerText = "Error"; });
            };

            var routeBtn = document.createElement('button');
            routeBtn.className = 'btn btn-success btn-sm w-100';
            routeBtn.innerHTML = '<i class="bi bi-sign-turn-right"></i> Directions Here';
            routeBtn.onclick = function() {
                if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
                map.closePopup();
                const tempMsg = L.popup().setLatLng([lat, lon]).setContent("Calculating route...").openOn(map);
                navigator.geolocation.getCurrentPosition(pos => {
                    var start = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    var end = L.latLng(lat, lon);
                    map.removeLayer(tempMsg);
                    
                    routingControl.setWaypoints([start, end]);
                    toggleRoutingPanel(true); // HIỆN SIDEBAR
                    
                    L.marker(start).addTo(map).bindPopup("Start: You are here");
                }, err => { alert("Could not get your location."); map.removeLayer(tempMsg); });
            };

            container.appendChild(titleEl);
            container.appendChild(addrEl);
            container.appendChild(viewBtn);
            container.appendChild(routeBtn);
            return container;
        }

        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            toggleRoutingPanel(false); // ẨN SIDEBAR
            routingControl.setWaypoints([]); 
            
            if (clickMarker) { map.removeLayer(clickMarker); }

            clickMarker = L.marker([lat, lon]).addTo(map);
            clickMarker.bindPopup('<div class="text-center">Loading address...<br><span class="spinner-border spinner-border-sm"></span></div>').openPopup();

            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            let isUpdated = false;

            fetch(url, { headers: { 'Accept-Language': 'vi-VN, vi;q=0.9, en;q=0.8' } })
                .then(response => response.json())
                .then(data => {
                    if (isUpdated) return;
                    isUpdated = true;
                    let name = "Dropped Pin";
                    let address = "Unknown Address";

                    if (data && data.address) {
                        address = data.display_name;
                        const p = data.address;
                        name = p.university || p.college || p.school || p.amenity || p.building || p.office || p.leisure || p.tourism || p.road || "Dropped Pin";
                    }
                    const content = createPopupContent(lat, lon, name, address);
                    clickMarker.setPopupContent(content);
                })
                .catch(err => { console.error(err); });

            setTimeout(() => {
                if (!isUpdated) {
                    isUpdated = true;
                    const coordName = `Loc: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    const content = createPopupContent(lat, lon, "Dropped Pin", coordName);
                    clickMarker.setPopupContent(content);
                }
            }, 3500);
        });

        let locations = [];
        try { locations = JSON.parse(mapElement.dataset.locations); } catch (e) {}
        var markers = L.markerClusterGroup();

        if (locations && locations.length > 0) {
            locations.forEach(function(loc) {
                if (!loc || !loc.lat || !loc.lon) return;
                const rating = parseFloat(loc.rating) || 0;
                const stars = '★'.repeat(Math.round(rating)) + '☆'.repeat(5 - Math.round(rating));
                const popupHtml = `
                    <div style="width:200px">
                        <h5>${loc.name}</h5>
                        ${rating > 0 ? `<div class="text-warning mb-1">${stars}</div>` : ''}
                        <p class="small">${(loc.desc || '').substring(0,70)}...</p>
                        <a href="${loc.url}" class="btn btn-primary btn-sm w-100">View Details</a>
                    </div>`;
                markers.addLayer(L.marker([loc.lat, loc.lon]).bindPopup(popupHtml));
            });
            map.addLayer(markers);
        }

        const geoErrorDiv = document.getElementById('geo-error'); 
        document.getElementById('find-me-btn').addEventListener('click', function() {
            if (!navigator.geolocation) { geoErrorDiv.textContent = 'Not supported'; return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude: lat, longitude: lon} = pos.coords;
                map.setView([lat, lon], 15);
                L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
            }, err => geoErrorDiv.textContent = err.message);
        });

        setTimeout(() => map.invalidateSize(), 100);
    }
    window.addEventListener('load', initMap);
</script>
{% endblock %}