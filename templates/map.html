{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<style>
    #map { 
        height: 600px; 
        border-radius: 0.25rem; 
        border: 1px solid #dee2e6; 
    }
    .leaflet-container { height: 100%; width: 100%; }
</style>

<div class="row">
    <div class="col-lg-4">
        
        <h2 class="mb-3">Search & Filter</h2>
        <form method="GET" action="{{ url_for('map_search') }}">
            <div class="mb-3">
                <label for="query" class="form-label">Search by Name</label>
                <input type="text" class="form-control" placeholder="Eiffel Tower..." name="query" id="query" value="{{ query or '' }}">
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="type" class="form-label">Type</label>
                    <select class="form-select" name="type" id="type">
                        <option value="" {% if not query_type %}selected{% endif %}>All Types</option>
                        <option value="Attraction" {% if query_type == 'Attraction' %}selected{% endif %}>Attraction</option>
                        <option value="Restaurant" {% if query_type == 'Restaurant' %}selected{% endif %}>Restaurant</option>
                        <option value="Hotel" {% if query_type == 'Hotel' %}selected{% endif %}>Hotel</option>
                        <option value="Education" {% if query_type == 'Education' %}selected{% endif %}>Education</option>
                        </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="price" class="form-label">Price Range</label>
                    <select class="form-select" name="price" id="price">
                        <option value="" {% if not query_price %}selected{% endif %}>Any Price</option>
                        <option value="1" {% if query_price == 1 %}selected{% endif %}>$</option>
                        <option value="2" {% if query_price == 2 %}selected{% endif %}>$$</option>
                        <option value="3" {% if query_price == 3 %}selected{% endif %}>$$$</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="rating" class="form-label">Minimum Rating</label>
                <select class="form-select" name="rating" id="rating">
                    <option value="" {% if not query_rating %}selected{% endif %}>Any Rating</option>
                    <option value="5" {% if query_rating == 5 %}selected{% endif %}>★★★★★</option>
                    <option value="4" {% if query_rating == 4 %}selected{% endif %}>★★★★☆ & up</option>
                    <option value="3" {% if query_rating == 3 %}selected{% endif %}>★★★☆☆ & up</option>
                    <option value="2" {% if query_rating == 2 %}selected{% endif %}>★★☆☆☆ & up</option>
                    <option value="1" {% if query_rating == 1 %}selected{% endif %}>★☆☆☆☆ & up</option>
                </select>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-primary" type="submit">Apply Filters</button>
                <a href="{{ url_for('map_search') }}" class="btn btn-outline-secondary">Clear Filters</a>
            </div>
        </form>
        <hr class="my-4">

        <div class="d-grid mb-3">
            <button class="btn btn-secondary" id="find-me-btn">
                <i class="bi bi-geo-alt-fill"></i> Find My Location
            </button>
        </div>
        <div id="geo-error" class="text-danger small mb-3"></div>
        
    </div>

    <div class="col-lg-8">
        <h2 class="mb-3">Interactive Map</h2>
        <div id="map" 
             data-default-lat="{{ default_lat if default_lat is defined and default_lat is not none else '' }}"
             data-default-lon="{{ default_lon if default_lon is defined and default_lon is not none else '' }}"
             data-locations='{{ locations_data|tojson|safe if locations_data is defined else "[]" }}'
        ></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    function initMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) return;
        
        // 1. Initialize Map
        let defaultLat = parseFloat(mapElement.dataset.defaultLat);
        let defaultLon = parseFloat(mapElement.dataset.defaultLon);
        let defaultZoom;
        
        if (isNaN(defaultLat) || isNaN(defaultLon)) {
            defaultLat = 20; defaultLon = 0; defaultZoom = 2;
        } else {
            defaultZoom = 13;
        }
        var map = L.map('map').setView([defaultLat, defaultLon], defaultZoom);

        // 2. Add Map Layers
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });
        L.control.layers({"Streets": streetLayer, "Satellite": satelliteLayer}).addTo(map);

        // 3. Add Address Search (Geocoder)
        L.Control.geocoder({ defaultMarkGeocode: false })
            .on('markgeocode', function(e) {
                map.fitBounds(e.geocode.bbox); 
                L.marker(e.geocode.center).addTo(map).bindPopup(e.geocode.name).openPopup();
            })
            .addTo(map);

        // 4. Parse Locations JSON
        let locations = [];
        const locationsJSON = mapElement.dataset.locations;
        try {
            locations = JSON.parse(locationsJSON);
        } catch (e) {
            console.error("Failed to parse locations JSON:", e);
            document.getElementById('geo-error').textContent = 'Error loading location data.';
        }
        
        // 5. Create Marker Cluster Group
        var markers = L.markerClusterGroup();

        // 6. Add DB Markers
        if (locations && locations.length > 0) {
            locations.forEach(function(loc) {
                if (!loc || typeof loc.lat === 'undefined' || typeof loc.lon === 'undefined') {
                    console.warn("Skipping invalid location data:", loc); return; 
                }
                
                // --- CẬP NHẬT POPUP ĐỂ HIỂN THỊ RATING ---
                const rating = parseFloat(loc.rating) || 0;
                const stars = '★'.repeat(Math.round(rating)) + '☆'.repeat(5 - Math.round(rating));
                const ratingText = rating > 0 ? `<h6 class="text-warning mb-2">${stars} <span class="text-muted small">(${rating.toFixed(1)})</span></h6>` : `<p class="text-muted small mb-2">No reviews yet</p>`;

                const popupDiv = document.createElement('div');
                popupDiv.style.fontFamily = 'Arial, sans-serif';
                popupDiv.style.width = '200px';

                const title = document.createElement('h5');
                title.style.marginBottom = '5px';
                title.textContent = loc.name || "Unnamed Location";

                const desc = document.createElement('p');
                desc.style.fontSize = '13px';
                desc.style.margin = '5px 0';
                desc.textContent = (loc.desc || loc.name || "No description").substring(0, 75) + '...';

                const link = document.createElement('a');
                link.href = loc.url || "#";
                link.className = 'btn btn-primary btn-sm d-block w-100';
                link.style.textDecoration = 'none';
                link.textContent = 'View Details';
                
                popupDiv.appendChild(title);
                popupDiv.innerHTML += ratingText; // Thêm HTML của rating
                popupDiv.appendChild(desc);
                popupDiv.appendChild(link);
                // --- KẾT THÚC CẬP NHẬT POPUP ---

                var marker = L.marker([loc.lat, loc.lon]).bindPopup(popupDiv);
                markers.addLayer(marker);
            });

            map.addLayer(markers);

            // Auto-zoom
            if (isNaN(defaultLat) && isNaN(defaultLon) && locations.length > 0) {
                 setTimeout(() => {
                    try { map.fitBounds(markers.getBounds().pad(0.3)); } 
                    catch (e) { console.warn("Could not auto-zoom:", e); }
                }, 100);
            }
        }
        
        // 9. "Find Me" Button
        const geoErrorDiv = document.getElementById('geo-error'); 
        document.getElementById('find-me-btn').addEventListener('click', function() {
            geoErrorDiv.textContent = ''; 
            if (!navigator.geolocation) {
                geoErrorDiv.textContent = 'Geolocation is not supported by this browser.'; return;
            }
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude; var lon = position.coords.longitude;
                map.setView([lat, lon], 15);
                L.marker([lat, lon]).addTo(map).bindPopup("<strong>You are here!</strong>").openPopup();
            }, function(err) {
                geoErrorDiv.textContent = 'Could not get your location. Error: ' + err.message;
            });
        });

        // Fix for broken tiles
        setTimeout(() => map.invalidateSize(), 100);
    }
    
    // Dùng 'load' để đảm bảo CSS đã được áp dụng
    window.addEventListener('load', initMap);
</script>
{% endblock %}