{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<style>
    .map-container {
        position: relative;
        width: 100%;
    }
    #map { 
        height: calc(100vh - 80px); 
        width: 100%;
        border-radius: 0.375rem; 
        border: 1px solid #dee2e6; 
        z-index: 500;
        cursor: crosshair; 
    }
    .leaflet-container { height: 100%; width: 100%; }

    /* Floating Controls Panel */
    .map-controls {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 1000; 
        background: #fff;
        padding: 1rem;
        border-radius: 0.375rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 220px; 
    }
    .leaflet-routing-container { z-index: 1000; }
</style>

<div class="map-container">
    <div class="map-controls">
        <div class="d-grid mb-2">
            <button class="btn btn-secondary" id="find-me-btn">
                <i class="bi bi-geo-alt-fill"></i> Find My Location
            </button>
        </div>
        <div id="geo-error" class="text-danger small"></div>
    </div>

    <div id="map" 
         data-default-lat="{{ default_lat if default_lat is defined and default_lat is not none else '' }}"
         data-default-lon="{{ default_lon if default_lon is defined and default_lon is not none else '' }}"
         data-locations='{{ locations_data|tojson|safe if locations_data is defined else "[]" }}'
    ></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    function initMap() {
        console.log("Initializing Map...");
        const mapElement = document.getElementById('map');
        if (!mapElement) return;
        
        // 1. Initialize Map
        let defaultLat = parseFloat(mapElement.dataset.defaultLat);
        let defaultLon = parseFloat(mapElement.dataset.defaultLon);
        let defaultZoom = (isNaN(defaultLat) || isNaN(defaultLon)) ? 2 : 13;
        if (isNaN(defaultLat)) { defaultLat = 20; defaultLon = 0; }

        // Disable default zoom control so we can move it
        var map = L.map('map', { zoomControl: false }).setView([defaultLat, defaultLon], defaultZoom);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // 2. Layers
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // 3. Routing (Directions)
        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            show: false,
            createMarker: function() { return null; }
        }).addTo(map);

        // 4. Search Bar (Wrapped in Try/Catch so it doesn't break the rest of the app)
        try {
            var geocoder = L.Control.Geocoder.nominatim();
            L.Control.geocoder({ defaultMarkGeocode: false, geocoder: geocoder })
                .on('markgeocode', function(e) { map.fitBounds(e.geocode.bbox); })
                .addTo(map);
        } catch (e) {
            console.error("Search bar plugin failed to load:", e);
        }

        // ============================================================
        // 5. THE NEW STABLE CLICK HANDLER (Uses direct API Fetch)
        // ============================================================
        var clickMarker;

        // Function to generate the popup HTML content
        function createPopupContent(lat, lon, name, address) {
            var container = document.createElement('div');
            container.style.textAlign = "center";
            container.style.width = "200px";
            
            var titleEl = document.createElement('strong');
            titleEl.innerText = name;
            titleEl.style.display = "block";
            titleEl.style.marginBottom = "5px";

            var addrEl = document.createElement('p');
            addrEl.innerText = address;
            addrEl.style.fontSize = "12px";
            addrEl.className = "text-muted";
            addrEl.style.marginBottom = "10px";

            // View Details Button
            var viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-primary btn-sm w-100 mb-2';
            viewBtn.innerHTML = '<i class="bi bi-eye"></i> View Details';
            viewBtn.onclick = function() {
                viewBtn.disabled = true;
                viewBtn.innerText = "Saving...";
                fetch('/api/create_location_on_click', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: lat, lon: lon, name: name, address: address})
                })
                .then(r => r.json())
                .then(data => { if(data.url) window.location.href = data.url; })
                .catch(err => { console.error(err); viewBtn.innerText = "Error"; });
            };

            // Directions Button
            var routeBtn = document.createElement('button');
            routeBtn.className = 'btn btn-success btn-sm w-100';
            routeBtn.innerHTML = '<i class="bi bi-sign-turn-right"></i> Directions Here';
            routeBtn.onclick = function() {
                if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
                map.closePopup();
                const tempMsg = L.popup().setLatLng([lat, lon]).setContent("Calculating route...").openOn(map);
                navigator.geolocation.getCurrentPosition(pos => {
                    var start = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    var end = L.latLng(lat, lon);
                    map.removeLayer(tempMsg);
                    routingControl.setWaypoints([start, end]);
                    routingControl.show();
                    L.marker(start).addTo(map).bindPopup("Start: You are here");
                }, err => { alert("Could not get your location."); map.removeLayer(tempMsg); });
            };

            container.appendChild(titleEl);
            container.appendChild(addrEl);
            container.appendChild(viewBtn);
            container.appendChild(routeBtn);
            return container;
        }

        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            console.log("Map Clicked at:", lat, lon);

            // 1. Clear old UI
            if (clickMarker) { map.removeLayer(clickMarker); }
            routingControl.hide(); 
            routingControl.setWaypoints([]); 

            // 2. Place Marker immediately
            clickMarker = L.marker([lat, lon]).addTo(map);
            clickMarker.bindPopup('<div class="text-center">Loading address...<br><span class="spinner-border spinner-border-sm"></span></div>').openPopup();

            // 3. Perform Direct API Call
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            
            let isUpdated = false;

            fetch(url, { headers: { 'Accept-Language': 'vi-VN, vi;q=0.9, en;q=0.8' } }) // Prefer Vietnamese
                .then(response => response.json())
                .then(data => {
                    if (isUpdated) return;
                    isUpdated = true;

                    let name = "Dropped Pin";
                    let address = "Unknown Address";

                    if (data && data.address) {
                        address = data.display_name; // The full address string
                        
                        // Smart Naming Logic
                        const p = data.address;
                        name = p.university || p.college || p.school || p.amenity || p.building || p.office || p.leisure || p.tourism || p.road || "Dropped Pin";
                    } else if (data && data.error) {
                         console.warn("Nominatim API Error:", data.error);
                    }

                    const content = createPopupContent(lat, lon, name, address);
                    clickMarker.setPopupContent(content);
                })
                .catch(err => {
                    console.error("Geocoding Fetch Error:", err);
                });

            // 4. Safety Timeout (3.5 seconds)
            // If API is blocked or slow, force the popup to show coordinates
            setTimeout(() => {
                if (!isUpdated) {
                    console.warn("Geocoding timed out. Falling back to coordinates.");
                    isUpdated = true;
                    const coordName = `Loc: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    const content = createPopupContent(lat, lon, "Dropped Pin", coordName);
                    clickMarker.setPopupContent(content);
                }
            }, 3500);
        });

        // ============================================================
        // END NEW LOGIC
        // ============================================================

        // 6. Load Existing DB Locations
        let locations = [];
        try { locations = JSON.parse(mapElement.dataset.locations); } catch (e) {}
        var markers = L.markerClusterGroup();

        if (locations && locations.length > 0) {
            locations.forEach(function(loc) {
                if (!loc || !loc.lat || !loc.lon) return;
                const rating = parseFloat(loc.rating) || 0;
                const stars = '★'.repeat(Math.round(rating)) + '☆'.repeat(5 - Math.round(rating));
                const popupHtml = `
                    <div style="width:200px">
                        <h5>${loc.name}</h5>
                        ${rating > 0 ? `<div class="text-warning mb-1">${stars}</div>` : ''}
                        <p class="small">${(loc.desc || '').substring(0,70)}...</p>
                        <a href="${loc.url}" class="btn btn-primary btn-sm w-100">View Details</a>
                    </div>`;
                markers.addLayer(L.marker([loc.lat, loc.lon]).bindPopup(popupHtml));
            });
            map.addLayer(markers);
        }

        // 7. Find Me Button
        const geoErrorDiv = document.getElementById('geo-error'); 
        document.getElementById('find-me-btn').addEventListener('click', function() {
            if (!navigator.geolocation) { geoErrorDiv.textContent = 'Not supported'; return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude: lat, longitude: lon} = pos.coords;
                map.setView([lat, lon], 15);
                L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
            }, err => geoErrorDiv.textContent = err.message);
        });

        setTimeout(() => map.invalidateSize(), 100);
    }
    window.addEventListener('load', initMap);
</script>
{% endblock %}