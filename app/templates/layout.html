<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FriendUS{% if title %} - {{ title }}{% endif %}</title>
    
    {{ bootstrap.load_css() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/vietmap-gl-js@4.2.0/vietmap-gl.css" rel="stylesheet" />

    <style>
        /* --- LAYOUT FIX: Flexbox Column --- */
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll, let inner divs scroll */
        }
        
        /* Navbar stays at top, natural height */
        .navbar {
            flex: 0 0 auto; 
            margin-bottom: 0 !important; /* Remove bottom margin to touch map */
            z-index: 1050;
        }

        /* Main Content Fills Remaining Space */
        #main-wrapper {
            flex: 1 1 auto;
            position: relative;
            overflow-y: auto; /* Allow scrolling for normal pages */
            overflow-x: hidden;
            background: #f8f9fa;
        }

        /* --- SCATTERED WIDGET STYLES --- */
        .scattered-toggle-btn {
            position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px;
            background-color: #4a90e2; color: white; border-radius: 50%; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer;
            font-size: 24px; display: flex; align-items: center; justify-content: center;
        }
        .scattered-widget {
            position: fixed; bottom: 90px; left: 20px; width: 320px; height: 450px;
            background-color: #ffffff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 2000; display: none; flex-direction: column; border: 1px solid #e0e0e0;
        }
        .sw-list { flex: 1; padding: 10px; overflow-y: auto; }
        .sw-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .sw-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2100; display: none; justify-content: center; align-items: center;
        }
        .sw-modal-box { background: white; padding: 20px; border-radius: 10px; width: 300px; }
    </style>
  </head>
  <body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">FriendUS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
          {% if current_user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('map.map') }}">Map</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('chat.chat') }}">Chat</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.profile', username=current_user.username) }}">Profile</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a></li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.login') }}">Login</a></li>
          {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div id="main-wrapper">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% if full_width %}
            {% block content %}{% endblock %}
        {% else %}
            <div class="container mt-4">
                {% block content %}{% endblock %}
            </div>
        {% endif %}
    </div>

    {% if current_user.is_authenticated %}
    <button class="scattered-toggle-btn" onclick="toggleWidget()"><i class="bi bi-journal-bookmark-fill"></i></button>
    <div class="scattered-widget" id="swWidget">
        <div style="padding:10px; background:#f1f1f1;"><h6 class="m-0">Saved Links</h6></div>
        <div class="sw-list" id="swList"></div>
        <div style="padding:10px; text-align:center;"><button class="btn btn-primary btn-sm w-100" onclick="openSwModal()">+ Add</button></div>
    </div>
    <div class="sw-modal-overlay" id="swModal">
        <div class="sw-modal-box">
            <h6>Add Link</h6>
            <input type="text" id="swInputTitle" class="form-control mb-2" placeholder="Title">
            <input type="text" id="swInputLink" class="form-control mb-2" placeholder="Link/Content">
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary btn-sm" onclick="closeSwModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="addSwItem()">Save</button>
            </div>
        </div>
    </div>
    {% endif %}

    {{ bootstrap.load_js() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vietmap-gl-js@4.2.0/vietmap-gl.js"></script>

    <script>
        // Widget Scripts
        const swWidget = document.getElementById('swWidget');
        const swModal = document.getElementById('swModal');
        const swList = document.getElementById('swList');
        
        function toggleWidget() { swWidget.style.display = (swWidget.style.display === 'flex') ? 'none' : 'flex'; loadSwItems(); }
        function openSwModal() { swModal.style.display = 'flex'; }
        function closeSwModal() { swModal.style.display = 'none'; }
        
        function loadSwItems() {
            swList.innerHTML = '';
            const data = JSON.parse(localStorage.getItem('scattered_info') || '[]');
            data.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'sw-item';
                div.innerHTML = `<div><strong>${item.title}</strong><br><small>${item.link}</small></div><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">x</button>`;
                swList.appendChild(div);
            });
        }
        function addSwItem() {
            const t = document.getElementById('swInputTitle').value;
            const l = document.getElementById('swInputLink').value;
            if(!t) return;
            const data = JSON.parse(localStorage.getItem('scattered_info') || '[]');
            data.push({title: t, link: l});
            localStorage.setItem('scattered_info', JSON.stringify(data));
            closeSwModal(); loadSwItems();
        }
        function removeItem(i) {
            const data = JSON.parse(localStorage.getItem('scattered_info') || '[]');
            data.splice(i, 1);
            localStorage.setItem('scattered_info', JSON.stringify(data));
            loadSwItems();
        }
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>