{% extends "layout.html" %}

{% set full_width = True %}

{% block content %}
<style>
    /* Map Interface Styles */
    #map-container {
        display: flex;
        flex: 1;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    #sidebar {
        width: 350px;
        min-width: 350px;
        height: 100%;
        overflow-y: auto;
        background: white;
        z-index: 1000;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    #map {
        flex-grow: 1;
        height: 100%;
        width: 100%;
    }

    /* Result Card Styles */
    .result-card {
        cursor: pointer;
        transition: background 0.2s;
        border-left: 4px solid transparent;
    }
    .result-card:hover {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
    }
    .result-card small {
        display: block;
        color: #6c757d;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        #sidebar {
            width: 100%;
            height: 40%;
            position: absolute;
            bottom: 0;
            top: auto;
            border-top: 2px solid #ddd;
        }
        #map-container {
            flex-direction: column;
        }
    }
</style>

<div id="map-container">
    
    <div id="sidebar" class="border-end">
        <div class="p-3 border-bottom bg-light">
            <h5 class="mb-3"><i class="bi bi-search"></i> VietMap Search</h5>
            
            <form id="search-form" onsubmit="event.preventDefault(); handleSearch();">
                <div class="input-group mb-2">
                    <input type="text" id="search-input" class="form-control" placeholder="Search address, place...">
                    <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                </div>
            </form>
            <small class="text-muted">Searching VietMap Database</small>
        </div>

        <div class="flex-grow-1 overflow-auto">
            <div class="list-group list-group-flush" id="api-results">
                <div class="p-4 text-center text-muted">
                    <i class="bi bi-globe-asia-australia fs-1"></i>
                    <p>Search for a place or click the map to see the address.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

</div>

<script id="map-config" type="application/json">
{
    "apiKey": "{{ vietmap_api_key }}",
    "defaultLat": {{ default_lat or 10.762622 }},
    "defaultLon": {{ default_lon or 106.660172 }},
    "savedLocations": {{ locations_data | tojson }}
}
</script>

{% endblock %}

{% block scripts %}
<script>
    // 1. Load Config
    const configData = document.getElementById('map-config').textContent;
    const CONFIG = JSON.parse(configData);

    // 2. Initialize Map
    const map = new vietmapgl.Map({
        container: 'map',
        style: `https://maps.vietmap.vn/maps/styles/tm/style.json?apikey=${CONFIG.apiKey}`,
        center: [CONFIG.defaultLon, CONFIG.defaultLat],
        zoom: 13,
        pitch: 0
    });

    map.addControl(new vietmapgl.NavigationControl(), 'top-right');
    map.addControl(new vietmapgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true
    }), 'top-right');

    // 3. Render Saved Database Locations (Optional: keep them visible)
    CONFIG.savedLocations.forEach(loc => {
        const popup = new vietmapgl.Popup({ offset: 25 })
            .setHTML(`<strong>${loc.name}</strong><br><a href="${loc.url}">View Details</a>`);
        
        new vietmapgl.Marker({ color: "#198754" }) // Green for saved locations
            .setLngLat([loc.lon, loc.lat])
            .setPopup(popup)
            .addTo(map);
    });

    // ---------------------------------------------------------
    // FEATURE 1: SEARCH (Geocoding / Autocomplete API)
    // ---------------------------------------------------------
    async function handleSearch() {
        const query = document.getElementById('search-input').value;
        if (!query) return;

        const resultsContainer = document.getElementById('api-results');
        resultsContainer.innerHTML = '<div class="p-3 text-center"><div class="spinner-border text-primary" role="status"></div></div>';

        try {
            // Call VietMap Autocomplete API
            const url = `https://maps.vietmap.vn/api/autocomplete/v3?apikey=${CONFIG.apiKey}&text=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            const data = await res.json();

            resultsContainer.innerHTML = ''; // Clear spinner

            if (data && data.length > 0) {
                data.forEach(place => {
                    // Create Result Item
                    const item = document.createElement('div');
                    item.className = 'list-group-item result-card p-3';
                    
                    // Format output safely
                    const name = place.name || place.address || "Unknown Place";
                    const address = place.address || "";
                    
                    item.innerHTML = `
                        <h6 class="mb-1 text-primary fw-bold">${name}</h6>
                        <small>${address}</small>
                    `;
                    
                    // On Click: Fly to location
                    item.onclick = () => {
                        const lat = place.lat;
                        const lng = place.lng; // Note: API usually returns 'lng' or 'lon'
                        
                        // Fly to
                        map.flyTo({ center: [lng, lat], zoom: 16 });

                        // Add Temporary Marker
                        new vietmapgl.Marker({ color: "#0d6efd" })
                            .setLngLat([lng, lat])
                            .setPopup(new vietmapgl.Popup().setHTML(`<b>${name}</b><br>${address}`))
                            .addTo(map)
                            .togglePopup();
                    };

                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-center text-muted">No results found.</div>';
            }
        } catch (err) {
            console.error(err);
            resultsContainer.innerHTML = '<div class="p-3 text-center text-danger">Error searching map.</div>';
        }
    }

    // ---------------------------------------------------------
    // FEATURE 2: REVERSE GEOCODING (Click Map -> Show Info)
    // ---------------------------------------------------------
    let clickMarker = null; // Store reference to remove old click markers

    map.on('click', async (e) => {
        // Ignore clicks on existing markers
        if (e.originalEvent.target.closest('.mapboxgl-marker')) return;

        const { lng, lat } = e.lngLat;

        // Remove previous click marker if exists
        if (clickMarker) clickMarker.remove();

        // 1. Add Visual Marker immediately
        clickMarker = new vietmapgl.Marker({ color: "#dc3545" }) // Red for click
            .setLngLat([lng, lat])
            .addTo(map);

        // 2. Call Reverse Geocode API
        try {
            const url = `https://maps.vietmap.vn/api/reverse/v3?apikey=${CONFIG.apiKey}&lng=${lng}&lat=${lat}`;
            const res = await fetch(url);
            const data = await res.json();

            let displayMsg = "Lat: " + lat.toFixed(5) + ", Lng: " + lng.toFixed(5);
            
            if (data && data[0]) {
                const addr = data[0].address || "Unknown Address";
                const name = data[0].name || "";
                displayMsg = name ? `<b>${name}</b><br>${addr}` : addr;
            }

            // 3. Show Popup
            const popup = new vietmapgl.Popup({ offset: 25 })
                .setHTML(displayMsg);
            
            clickMarker.setPopup(popup).togglePopup();

        } catch (err) {
            console.error("Reverse geocode failed", err);
        }
    });

</script>
{% endblock %}