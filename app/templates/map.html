{% extends "layout.html" %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
{% endblock %}

{% block content %}
<style>
    /* Map Container fills the flex parent immediately */
    .map-container-wrapper {
        position: relative;
        width: 100%;
        height: 100%; /* Fills #main-wrapper */
        overflow: hidden;
    }
    
    #map { 
        width: 100%; 
        height: 100%; 
        position: absolute; 
        top: 0; left: 0;
        z-index: 1; /* Base layer */
    }

    /* Floating Search Bar */
    .search-panel {
        position: absolute;
        top: 20px; left: 20px;
        width: 350px;
        background: white;
        z-index: 100; /* Above Map */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .search-input-group { display: flex; align-items: center; padding: 10px; }
    .search-input-group input { border: none; outline: none; flex: 1; margin-left: 10px; }
    .search-results { max-height: 300px; overflow-y: auto; display: none; border-top: 1px solid #eee; }
    .result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
    .result-item:hover { background: #f0f0f0; }

    /* Locate Button */
    .locate-btn {
        position: absolute; bottom: 30px; right: 20px;
        width: 50px; height: 50px;
        background: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 100; cursor: pointer; font-size: 20px;
    }
</style>

<div class="map-container-wrapper">
    <div class="search-panel">
        <div class="search-input-group">
            <i class="bi bi-search text-muted"></i>
            <input type="text" id="vm-search" placeholder="Search places...">
            <i class="bi bi-x" id="vm-clear" style="cursor: pointer; display: none;"></i>
        </div>
        <div id="vm-results" class="search-results"></div>
    </div>

    <div class="locate-btn" id="btn-locate" title="Find Me">
        <i class="bi bi-crosshair"></i>
    </div>

    <div id="map" 
         data-key="{{ vietmap_api_key }}" 
         data-lat="{{ default_lat }}" 
         data-lon="{{ default_lon }}"
         data-locs='{{ locations_data|tojson|safe }}'>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const mapEl = document.getElementById('map');
    const apiKey = mapEl.dataset.key;
    const defLat = parseFloat(mapEl.dataset.lat) || 10.762;
    const defLon = parseFloat(mapEl.dataset.lon) || 106.660;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!apiKey || apiKey === "None") {
        console.error("API Key missing");
        alert("Error: VIETMAP_API_KEY is missing. Map cannot load.");
        return;
    }

    // 1. Initialize Map
    console.log("Initializing VietMapGL...");
    const map = new vietmapgl.Map({
        container: 'map',
        style: `https://maps.vietmap.vn/mt/tm/style.json?apikey=${apiKey}`,
        center: [defLon, defLat],
        zoom: 13,
        pitch: 0
    });

    map.addControl(new vietmapgl.NavigationControl(), 'bottom-right');

    // 2. Load Markers
    map.on('load', () => {
        console.log("Map Loaded.");
        try {
            const locs = JSON.parse(mapEl.dataset.locs || "[]");
            locs.forEach(l => {
                const el = document.createElement('div');
                el.innerHTML = '<i class="bi bi-geo-alt-fill text-danger" style="font-size:24px;"></i>';
                new vietmapgl.Marker(el)
                    .setLngLat([l.lon, l.lat])
                    .setPopup(new vietmapgl.Popup().setHTML(`<b>${l.name}</b><br><a href="${l.url}">Details</a>`))
                    .addTo(map);
            });
        } catch(e) { console.error(e); }
    });

    // 3. Search Logic
    const searchIn = document.getElementById('vm-search');
    const searchRes = document.getElementById('vm-results');
    let timer;

    searchIn.addEventListener('input', (e) => {
        const q = e.target.value.trim();
        document.getElementById('vm-clear').style.display = q ? 'block' : 'none';
        if (q.length < 2) { searchRes.style.display = 'none'; return; }

        clearTimeout(timer);
        timer = setTimeout(() => {
            fetch(`https://maps.vietmap.vn/api/search/v3?apikey=${apiKey}&text=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => {
                    searchRes.innerHTML = '';
                    if (Array.isArray(data) && data.length) {
                        searchRes.style.display = 'block';
                        data.forEach(p => {
                            const d = document.createElement('div');
                            d.className = 'result-item';
                            d.innerText = p.name;
                            d.onclick = () => {
                                const lat = p.location?.lat || p.lat;
                                const lng = p.location?.lng || p.lng;
                                map.flyTo({ center: [lng, lat], zoom: 16 });
                                new vietmapgl.Popup()
                                    .setLngLat([lng, lat])
                                    .setHTML(createPopup(lat, lng, p.name, p.address))
                                    .addTo(map);
                                searchRes.style.display = 'none';
                            };
                            searchRes.appendChild(d);
                        });
                    }
                });
        }, 300);
    });

    // 4. Click to Drop Pin
    map.on('click', (e) => {
        const { lng, lat } = e.lngLat;
        fetch(`https://maps.vietmap.vn/api/reverse/v3?apikey=${apiKey}&lat=${lat}&lng=${lng}`)
            .then(r => r.json())
            .then(data => {
                let addr = data[0]?.address || data.address || "Unknown";
                new vietmapgl.Popup()
                    .setLngLat([lng, lat])
                    .setHTML(createPopup(lat, lng, "Dropped Pin", addr))
                    .addTo(map);
            });
    });

    // 5. Helper Functions
    function createPopup(lat, lng, name, addr) {
        return `<div style="text-align:center">
            <strong>${name}</strong><br><small>${addr}</small><br>
            <button class="btn btn-sm btn-primary mt-2" onclick="saveLoc(${lat},${lng},'${name}','${addr}')">Save</button>
        </div>`;
    }

    window.saveLoc = function(lat, lon, name, addr) {
        fetch('{{ url_for("map.create_location_on_click") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({lat, lon, name, address: addr})
        }).then(r=>r.json()).then(d => { if(d.url) window.location = d.url; });
    };

    document.getElementById('vm-clear').onclick = () => {
        searchIn.value = ''; searchRes.style.display = 'none';
    };
    
    // 6. Locate Me
    document.getElementById('btn-locate').onclick = () => {
        if(!navigator.geolocation) return alert("Geolocation needs HTTPS");
        navigator.geolocation.getCurrentPosition(pos => {
            const {latitude, longitude} = pos.coords;
            map.flyTo({center: [longitude, latitude], zoom: 16});
            new vietmapgl.Marker({color: 'green'}).setLngLat([longitude, latitude]).addTo(map);
        });
    };
});
</script>
{% endblock %}